name: workflow

on:
  push:
  pull_request:

jobs:
  build-and-test:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y gcc make
    
    - name: Build
      run: make clean && make
    
    - name: Make test and coverage scripts executable
      run: |
        chmod +x tests/e2e/integration_test.sh scripts/generate_coverage.sh
    
    - name: Run unit tests
      run: make unit-test 2>&1 | tee unit_test_report.txt || true
    
    - name: Run integration tests
      run: make test-e2e 2>&1 | tee integration_test_report.txt || true
    
    - name: Generate coverage
      run: make coverage 2>&1 | tee coverage_report.txt || true

    - name: Upload test reports
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: test-reports
        path: |
          unit_test_report.txt
          integration_test_report.txt
          coverage_report.txt
        retention-days: 30